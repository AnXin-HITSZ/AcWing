# 6. 实现微服务：匹配系统

**目录：**

[TOC]

---

## 一、集成 WebSocket

在 `pom.xml` 文件中添加依赖：
* `spring-boot-starter-websocket`；
* `fastjson`。

添加 `config.WebSocketConfig` 配置类：
```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.socket.server.standard.ServerEndpointExporter;

@Configuration
public class WebSocketConfig {

    @Bean
    public ServerEndpointExporter serverEndpointExporter() {

        return new ServerEndpointExporter();
    }
}
```

添加 `consumer.WebSocketServer` 类：
```java
import org.springframework.stereotype.Component;

import javax.websocket.*;
import javax.websocket.server.PathParam;
import javax.websocket.server.ServerEndpoint;

@Component
@ServerEndpoint("/websocket/{token}")  // 注意不要以'/'结尾
public class WebSocketServer {
    @OnOpen
    public void onOpen(Session session, @PathParam("token") String token) {
        // 建立连接
    }

    @OnClose
    public void onClose() {
        // 关闭链接
    }

    @OnMessage
    public void onMessage(String message, Session session) {
        // 从Client接收消息
    }

    @OnError
    public void onError(Session session, Throwable error) {
        error.printStackTrace();
    }
}
```

配置 `config.SecurityConfig`：
```java
@Override
public void configure(WebSecurity web) throws Exception {
    web.ignoring().antMatchers("/websocket/**");
}
```

验证 `jwt`。

## 二、实现前端界面

未知用户的图片：
![未知用户的图片](./images/1_1db2488f17-anonymous.png "未知用户的图片")

## 三、在数据库中创建表 `record`

`record` 表用来记录每局对战的信息。

表中的列：
* `id: int`；
* `a_id: int`；
* `a_sx: int`；
* `a_sy: int`；
* `b_id: int`；
* `b_sx: int`；
* `b_sy: int`；
* `a_steps: varchar(1000)`；
* `b_steps: varchar(1000)`；
* `map: varchar(1000)`；
* `loser: varchar(10)`；
* `createtime: datetime`。

## 四、实现匹配系统的微服务

创建 `SpringCloud` 项目。

在 SpringCloud 项目中添加依赖：
* Maven 仓库地址：[Maven 仓库地址](https://mvnrepository.com/)。
* `spring-cloud-dependencies`。

创建 `SpringCloud` 的子项目——`MatchingSystem`。

创建 `SpringCloud` 的子项目——`Backend`。