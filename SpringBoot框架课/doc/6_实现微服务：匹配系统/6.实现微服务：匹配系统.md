# 6. 实现微服务：匹配系统

**目录：**

[TOC]

---

匹配系统（Matching System）至少需要两名用户。用户向浏览器 Server 发送匹配请求，Server 接收到匹配请求后转发至后端匹配系统；匹配成功后，后端会将匹配结果发送回 Server，Server 再向每名玩家返回匹配结果，最终显示在前端。

由此可见，匹配系统的逻辑是**异步**的；我们并不知道发送匹配请求后需要多久能够匹配成功。

基于此应用场景，传统的 HTTP 协议将不再适用。

本项目选用 WebSocket 协议实现 Server。在 WebSocket 协议下，不仅客户端可以向服务器端发送消息，服务器端也可以向客户端发送消息，是全双工的。

当匹配成功之后，由 Server 需要引出新的系统 Game。Game 系统用于生成地图（Create Map）、蛇的移动与判定、结果返回等。其中判定需要通过 Judge 系统进行判定。

Game 不能作为单线程来处理，需要另起一个新的线程去做，因此我们需要将 Game 实现为多线程的类。

> 注意：匹配系统和用户代码执行系统均为微服务；微服务可以理解为可以实现某一功能的额外的程序。

因此，我们需要将之前在前端实现的部分逻辑移到云端。前端不做任何判定，只负责渲染。

同时，我们还需要实现将两名玩家的移动记录同步到三端，即 Client1 端、Client2 端、Server 端。Client1 端和 Client2 端将自己的下一步行动发送至 Server 端，Server 端接收到 Client1 端和 Client2 端的消息后将双方的下一步行动同时发送给 Client1 端和 Client2 端。

## 一、集成 WebSocket

在 `pom.xml` 文件中添加依赖：
* `spring-boot-starter-websocket`；
* `fastjson`。

添加 `config.WebSocketConfig` 配置类：
```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.socket.server.standard.ServerEndpointExporter;

@Configuration
public class WebSocketConfig {

    @Bean
    public ServerEndpointExporter serverEndpointExporter() {

        return new ServerEndpointExporter();
    }
}
```

添加 `consumer.WebSocketServer` 类：
```java
import org.springframework.stereotype.Component;

import javax.websocket.*;
import javax.websocket.server.PathParam;
import javax.websocket.server.ServerEndpoint;

@Component
@ServerEndpoint("/websocket/{token}")  // 注意不要以'/'结尾
public class WebSocketServer {
    @OnOpen
    public void onOpen(Session session, @PathParam("token") String token) {
        // 建立连接
    }

    @OnClose
    public void onClose() {
        // 关闭链接
    }

    @OnMessage
    public void onMessage(String message, Session session) {
        // 从Client接收消息
    }

    @OnError
    public void onError(Session session, Throwable error) {
        error.printStackTrace();
    }
}
```

配置 `config.SecurityConfig`：
```java
@Override
public void configure(WebSecurity web) throws Exception {
    web.ignoring().antMatchers("/websocket/**");
}
```

验证 `jwt`。

## 二、实现前端界面

未知用户的图片：
![未知用户的图片](./images/1_1db2488f17-anonymous.png "未知用户的图片")

## 三、在数据库中创建表 `record`

`record` 表用来记录每局对战的信息。

表中的列：
* `id: int`；
* `a_id: int`；
* `a_sx: int`；
* `a_sy: int`；
* `b_id: int`；
* `b_sx: int`；
* `b_sy: int`；
* `a_steps: varchar(1000)`；
* `b_steps: varchar(1000)`；
* `map: varchar(1000)`；
* `loser: varchar(10)`；
* `createtime: datetime`。

## 四、实现匹配系统的微服务

创建 `SpringCloud` 项目。

在 SpringCloud 项目中添加依赖：
* Maven 仓库地址：[Maven 仓库地址](https://mvnrepository.com/)。
* `spring-cloud-dependencies`。

创建 `SpringCloud` 的子项目——`MatchingSystem`。

创建 `SpringCloud` 的子项目——`Backend`。