# 4. 配置 Mysql 与注册登录模块

**目录：**

[TOC]

---

## 一、配置 Mysql

Mysql 可以包含多个数据库，每个数据库中可以有多张表，每张表中可以有多个属性（即列），且表中数据按行存储。

### 1.1 下载

Windows 下载地址：[Windows 下载地址](https://dev.mysql.com/downloads/windows/installer/8.0.html)。

Mac、Linux 下载地址：[Mac、Linux 下载地址](https://dev.mysql.com/downloads/mysql/)。

### 1.2 安装

![安装界面 - 1](./images/1_97f4574607-install1.png "安装界面 - 1")

![安装界面 - 2](./images/1_b9ae2a4807-install2.png "安装界面 - 2")

其他页面全选默认即可。

### 1.3 配置环境变量

将 `C:\Program Files\MySQL\MySQL Server 8.0\bin`（如果安装到了其他目录，填写相应目录的地址即可）添加到环境变量 `PATH` 中，这样就可以在任意目录的终端中执行 `mysql` 命令了。

### 1.4 `mysql` 服务的关闭与启动

`mysql` 服务默认开机自动启动，如果想手动操作，可以参考如下命令：
* 关闭：`net stop mysql80`。
* 启动：`net start mysql80`。

### 1.5 `mysql` 的常用操作

**1. 连接数据库服务**

连接用户名为 `root`、密码为 `123456` 的数据库服务：`mysql -uroot -p123456`。

**2. `show databases;`**

列出所有数据库。

**3. `create database kob;`**

创建数据库。

**4. `drop database kob;`**

删除数据库。

**5. `use kob;`**

使用数据库 `kob`。

**6. `show tables;`**

列出当前数据库的所有表。

**7. `create table user(id int, username varchar(100));`**

创建名称为 `user` 的表，表中包含 `id` 和 `username` 两个属性。

**8. `drop table user;`**

删除表。

**9. `insert into user values(1, 'yxc');`**

在表中插入数据。

**10. `select * from user;`**

查询表中所有数据。

**11. `delete from user where id = 2;`**

删除某行数据。

## 二、配置 SpringBoot

> Maven 仓库地址：[Maven 仓库地址](https://mvnrepository.com/)。
>
> Mybatis-Plus 官网：[Mybatis-Plus 官网](https://baomidou.com/)。

在 `pom.xml` 文件中添加依赖：
* `Spring Boot Starter JDBC`；
* `Project Lombok`；
* `MySQL Connector/J`；
* `mybatis-plus-boot-starter`；
* `mybatis-plus-generator`；
* `spring-boot-starter-security`；
* `jjwt-api`；
* `jjwt-impl`；
* `jjwt-jackson`。

在 `application.properties` 中添加数据库配置：
```properties
spring.datasource.username=root
spring.datasource.password=123456
spring.datasource.url=jdbc:mysql://localhost:3306/kob?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
```

SpringBoot 中的常用模块：
* `pojo` 层：将数据库中的表（table）对应成 Java 中的 `Class`。
* `mapper` 层（也叫 `Dao` 层）：将 `pojo` 层的 `Class` 中的增删改查操作（crud），映射成 sql 语句。
* `service` 层：实现具体的业务逻辑，组合使用 `mapper` 中的操作。
* `controller` 层：负责请求转发，接受页面过来的参数，传给 `service` 层处理，接到返回值，再传给页面。（即：调度 `service`。）

> 注意：`pojo` 层的上一层即为 Mysql。

## 三、修改 `Spring Security`

实现 `service.impl.UserDetailsServiceImpl` 类，继承自 `UserDetailsService` 接口，用来接入数据库信息。

实现 `config.SecurityConfig` 类，用来实现用户密码的加密存储。

示例代码：
```java
@COnfiguration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

实现 [`utils.JwtUtil` 类](https://www.acwing.com/blog/content/23255/)，为 `jwt` 工具类，用来创建、解析 `jwt token`。

实现 [`config.filter.JwtAuthenticationTokenFilter` 类](https://www.acwing.com/blog/content/23256/)，用来验证 `jwt token`，如果验证成功，则将 `User` 信息注入上下文中。

配置 [`config.SecurityConfig` 类](https://www.acwing.com/blog/content/23257/)，放行登录、注册等接口。

## 四、编写 API

将数据库中的 `id` 域变为自增：
* 在数据库中将 `id` 列变为自增。
* 在 `pojo.User` 类中添加注解：`@TableId(type = IdType.AUTO)`。

实现 `/user/account/token/`：验证用户名密码，验证成功后返回 `jwt token`（令牌）。

实现 `/user/account/info/`：根据令牌返回用户信息。

实现 `/user/account/register/`：注册账号。