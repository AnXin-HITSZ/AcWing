# 8. 租云服务器及配 docker 环境

**目录：**

[TOC]

---

## 一、概述

云平台的作用：
1. 存放我们的 docker 容器，让计算跑在云端。
2. 获得公网 IP 地址，让每个人可以访问到我们的服务。

任选一个云平台即可，推荐配置：
1. 1 核 2GB（后期可以动态扩容，前期配置低一些没关系）。
2. 网络带宽采用按量付费，最大带宽拉满即可（费用取决于用量，与最大带宽无关）。
3. 系统版本：Ubuntu 20.04 LTS（推荐用统一版本，避免后期出现配置不兼容的问题）。

AC Terminal、租到的服务器和 docker 的关系为 `AC Terminal -> 租到的服务器 -> docker`，即 AC Terminal 可以连接到多个租到的服务器，而某个租到的服务器可以创建多个 docker，未来的主要工作场所即在 docker 中。在云平台上采用 docker 的原因为 docker 便于迁移，以利于后期根据各大云服务器租赁商的价格任意更换云服务器租赁商。

> 注意：
>
> 租到的服务器分为**毛坯**和**服务**两大类。其中毛坯主要负责部署框架和 thrift 等，个性化较强，可以根据自己的需求进行修改；服务已被服务器提供商装修完成，个性化较弱，无法根据自己的需求进行修改，可通过 Socket（IP + Port）、http 等进行连接。
>
> 未来我们的项目的核心服务主要部署在毛坯服务器上，例如 Django 框架；而其余的服务主要部署在已装修好的服务器上，例如直播功能等。

## 二、租云服务器及安装 docker

> 注意：租用云服务器的带宽通常指下行带宽，即从云服务器向外流出的速度；而上行带宽通常没有限制。

### 2.1 阿里云

阿里云地址：[阿里云地址](https://www.aliyun.com/)。

#### 2.1.1 创建工作用户 `acs` 并赋予 `sudo` 权限

登录到新服务器。打开 [AC Terminal](https://www.acwing.com/file_system/file/content/whole/index/content/2543025/)，然后执行以下命令：
```bash
ssh root@xxx.xxx.xxx.xxx    # xxx.xxx.xxx.xxx 替换成新服务器的公网 IP
```

执行以下命令，创建 `acs` 用户：
```bash
adduser acs # 创建用户 acs
usermod -aG sudo acs    # 给用户 acs 分配 sudo 权限
```

#### 2.1.2 配置免密登录方式

退回 [AC Terminal](https://www.acwing.com/file_system/file/content/whole/index/content/2543025/)，然后配置 acs 用户的别名和免密登录，可以参考《4. ssh——ssh 登录》。

#### 2.1.3 配置新服务器的工作环境

将 [AC Terminal](https://www.acwing.com/file_system/file/content/whole/index/content/2543025/) 的配置传到新服务器上：
```bash
scp .bashrc .vimrc .tmux.conf server_name:  # server_name 需要换成自己配置的别名
```

#### 2.1.4 安装 `tmux` 和 `docker`

登录自己的服务器，然后安装 `tmux`：
```bash
sudo apt-get update
sudo apt-get install tmux
```

打开 `tmux`。（养成好习惯，所有工作都在 `tmux` 里进行，防止意外关闭终端后，工作进度丢失！）

然后在 `tmux` 中根据 [`docker` 安装教程](https://docs.docker.com/engine/install/ubuntu/) 安装 `docker` 即可。

### 2.2 腾讯云

腾讯云地址：[腾讯云地址](https://cloud.tencent.com/)。

#### 2.2.1 创建工作用户 `acs` 并赋予 `sudo` 权限

登录到新服务器。打开 [AC Terminal](https://www.acwing.com/file_system/file/content/whole/index/content/2543025/)，然后执行以下命令：
```bash
ssh root@xxx.xxx.xxx.xxx    # 注意腾讯云登录的用户不是 root，而是 ubuntu
```

执行以下命令，创建 `acs` 用户：
```bash
adduser acs # 创建用户 acs
usermod -aG sudo acs    # 给用户 acs 分配 sudo 权限
```

#### 2.2.2 配置免密登录方式

退回 [AC Terminal](https://www.acwing.com/file_system/file/content/whole/index/content/2543025/)，然后配置 `acs` 用户的别名和免密登录，可以参考《4. ssh——ssh 登录》。

#### 2.2.3 配置新服务器的工作环境

将 [AC Terminal](https://www.acwing.com/file_system/file/content/whole/index/content/2543025/) 的配置传到新服务器上：
```bash
scp .bashrc .vimrc .tmux.conf server_name:  # server_name 需要换成自己配置的别名
```

#### 2.2.4 安装 `tmux` 和 `docker`

登录自己的服务器，然后安装 `tmux`：
```bash
sudo apt-get update
sudo apt-get install tmux
```

打开 `tmux`。（养成好习惯，所有工作都在 `tmux` 里进行，防止意外关闭终端后，工作进度丢失！）

然后在 `tmux` 中根据 [`docker` 安装教程](https://docs.docker.com/engine/install/ubuntu/) 安装 `docker` 即可。

### 2.3 华为云

华为云地址：[华为云地址](https://www.huaweicloud.com/)。

#### 2.3.1 创建工作用户 `acs` 并赋予 `sudo` 权限

登录到新服务器。打开 [AC Terminal](https://www.acwing.com/file_system/file/content/whole/index/content/2543025/)，然后执行以下命令：
```bash
ssh root@xxx.xxx.xxx.xxx    # xxx.xxx.xxx.xxx 替换成新服务器的公网 IP
```

执行以下命令，创建 `acs` 用户：
```bash
adduser acs # 创建用户 acs
usermod -aG sudo acs    # 给用户 acs 分配 sudo 权限
```

#### 2.3.2 配置免密登录方式

退回 [AC Terminal](https://www.acwing.com/file_system/file/content/whole/index/content/2543025/)，然后配置 `acs` 用户的别名和免密登录，可以参考《4. ssh——ssh 登录》。

#### 2.3.3 配置新服务器的工作环境

将 [AC Terminal](https://www.acwing.com/file_system/file/content/whole/index/content/2543025/) 的配置传到新服务器上：
```bash
scp .bashrc .vimrc .tmux.conf server_name:  # server_name 需要换成自己配置的别名
```

#### 2.3.4 安装 `tmux` 和 `docker`

登录自己的服务器，然后安装 `tmux`：
```bash
sudo apt-get update
sudo apt-get install tmux
```

打开 `tmux`。（养成好习惯，所有工作都在 `tmux` 里进行，防止意外关闭终端后，工作进度丢失！）

然后在 `tmux` 中根据 [docker 安装教程](https://docs.docker.com/engine/install/ubuntu/) 安装 `docker` 即可。

## 三、docker 教程

docker 可以包含多个镜像（image），每一个镜像可以生成多个容器（container），每一个容器都是一个完全独立的服务器。

相同的镜像生成的容器是完全相同的。

镜像和容器的关系类似于印章和图案的关系，其中镜像相当于印章，而容器相当于图案；印章可以随意盖章且盖出的图案是完全相同的，即镜像可以随意生成容器且生成的容器的环境是完全相同的。

> 注意：docker 会自动对镜像和容器进行空间优化。

### 3.1 将当前用户添加到 `docker` 用户组

为了避免每次使用 `docker` 命令都需要加上 `sudo` 权限，可以将当前用户加入安装中自动创建的 `docker` 用户组（可以参考 [官方文档](https://docs.docker.com/engine/install/linux-postinstall/)）：
```bash
sudo usermod -aG docker $USER
```

执行完此操作后，需要退出服务器，再重新登录回来，才可以省去 `sudo` 权限。

### 3.2 镜像（images）

**1. `docker pull ubuntu:20.04`**

拉取一个镜像。

> 注意：所有的镜像名称由两部分组成，即 `xxxx:xxxx`；其中 `:` 前的部分为名称，`:` 后的部分为 tag（即版本号）。

**2. `docker images`**

列出本地所有镜像。

**3. `docker image rm ubuntu:20.04` 或 `docker rmi ubuntu:20.04`**

删除镜像 `ubuntu:20.04`。

**4. `docker [container] commit CONTAINER IMAGE_NAME:TAG`**

创建某个 `container` 的镜像。

**5. `docker save -o ubuntu_20_04.tar ubuntu:20.04`**

将镜像 `ubuntu:20.04` 导出到本地文件 `ubuntu_20_04.tar` 中。

**6. `docker load -i ubuntu_20_04.tar`**

将镜像 `ubuntu:20.04` 从本地文件 `ubuntu_20_04.tar` 中加载出来。

### 3.3 容器（container）

**1. `docker [container] create -it ubuntu:20.04`**

利用镜像 `ubuntu:20.04` 创建一个容器。

**2. `docker ps -a`**

查看本地的所有容器。

* `docker ps`：查看正在运行的容器。

**3. `docker [container] start CONTAINER`**

启动容器。

**4. `docker [container] stop CONTAINER`**

停止容器。

**5. `docker [container] restart CONTAINER`**

重启容器。

**6. `docker [container] run -itd ubuntu:20.04`**

创建并启动一个容器。

* `docker [container] run -it ubuntu:20.04`：创建、启动一个容器并进入。

**7. `docker [container] attach CONTAINER`**

进入容器。

> 注意：我们只能进入正在运行中的容器。

* 先按 `Ctrl + p`、再按 `Ctrl + q` 可以挂起容器，容器不会被关闭。

**8. `docker [container] exec CONTAINER COMMAND`**

在容器中执行命令。

**9. `docker [container] rm CONTAINER`**

删除容器。

> 注意：在删除容器之前，需要先将该容器关掉。

**10. `docker container prune`**

删除所有已停止的容器。

**11. `docker export -o xxx.tar CONTAINER`**

将容器 `CONTAINER` 导出到本地文件 `xxx.tar` 中。

**12. `docker import xxx.tar image_name:tag`**

将本地文件 `xxx.tar` 导入成镜像，并将镜像命名为 `image_name:tag`。

**13. `docker export/import` 与 `docker save/load`**

`docker export/import` 与 `docker save/load` 的区别：
* `export/import` 会丢弃历史记录和元数据信息，仅保存容器当前的快照状态。
* `save/load` 会保存完整记录，体积更大。

> 注意：容器是无法被迁移的，能够被迁移的是镜像。

**14. `docker top CONTAINER`**

查看某个容器内的所有进程。

**15. `docker stats`**

查看所有容器的统计信息，包括 CPU、内存、存储、网络等信息。

**16. `docker cp xxx CONTAINER:xxx` 或 `docker cp CONTAINER:xxx xxx`**

在本地和容器间复制文件。

> 注意：docker 的复制命令（`cp`）在对文件夹进行操作时不需要添加 `-r` 参数。

**17. `docker rename CONTAINER1 CONTAINER2`**

重命名容器。

**18. `docker update CONTAINER --memory 500MB`**

修改容器限制。

### 3.4 实战

进入 AC Terminal，然后执行以下命令：
```bash
scp /var/lib/acwing/docker/images/docker_lesson_1_0.tar server_name:    # 将镜像上传到自己租的云端服务器
ssh server_name # 登录自己的云端服务器

docker load -i docker_lesson_1_0.tar    # 将镜像加载到本地
docker run -p 20000:22 --name my_docker_server -itd docker_lesson:1.0   # 创建并运行 docker_lesson:1.0 镜像，并设置端口映射 20000:22

docker attach my_docker_server  # 进入创建的 docker 容器
passwd  # 设置 root 密码
```

上述命令执行完成之后，先按 `Ctrl + p`、再按 `Ctrl + q` 挂起容器，再进行以下步骤。

> 注意：
> 
> 此处一定要通过先按 `Ctrl + p`、再按 `Ctrl + q` 的方式将容器挂起，否则之后在键入命令 `ssh root@xxx.xxx.xxx.xxx -p 20000` 后会出现以下报错：
> ```bash
> acs@b0ad6aa7e2ad:~$ ssh root@120.76.157.2 -p 20000
> ssh: connect to host 120.76.157.2 port 20000: Connection refused
> ```
>
> 因此，切记在使用命令 `ssh root@xxx.xxx.xxx.xxx -p 20000` 通过 `ssh` 登录自己的 `docker` 容器前将该 `docker` 容器挂起！

去云平台控制台中修改安全组配置，放行端口 `20000`。

返回 AC Terminal，即可通过 `ssh` 登录自己的 `docker` 容器：
```bash
ssh root@xxx.xxx.xxx.xxx -p 20000   # 将 xxx.xxx.xxx.xxx 替换成自己租的服务器的 IP 地址
```

然后，可以仿照 二、租云服务器及安装 docker 的内容，创建工作账户 `acs`。

最后，可以参考《4. ssh——ssh 登录》配置 `docker` 容器的别名和免密登录。

> 小 Tips：如果 `apt-get` 下载软件速度较慢，可以参考 [清华大学开源软件镜像站](https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/) 中的内容，修改软件源。

> 注意：如果愿意的话，可以在我们租用的云服务器创建的 docker 容器内（即我们自己创建的云服务器上）继续创建新的云服务器，以此类推即可进行套娃操作；即我们的 docker 容器是**完备的**。