# 7. 管道、环境变量与常用命令

**目录：**

[TOC]

---

## 一、管道

### 1.1 概念

管道类似于文件重定向，可以将前一个命令的 `stdout` 重定向到下一个命令的 `stdin`。

### 1.2 要点

管道的要点如下所示：
1. 管道命令仅处理 `stdout`，会忽略 `stderr`。
2. 管道右边的命令必须能接受 `stdin`。
3. 多个管道命令可以串联。

> 注意：
> * 某些命令无法接受 `stdin`，例如 `rm -r` 命令只能接受文件参数而无法接受 `stdin`。
> * `cat` 命令可以接受标准输入，但会直接将标准输入原封不动地输出出来；例如 `find . -name '*.py' | cat | wc -l` 将会统计由 `find . -name '*.py'` 输出的所有文件的**文件名**的总行数，而非统计 `find . -name '*.py'` 输出的所有文件的总行数。

### 1.3 与文件重定向的区别

管道与文件重定向的区别如下所示：
* 文件重定向左边为命令，右边为文件。
* 管道左右两边均为命令，左边有 `stdout`，右边有 `stdin`。

### 1.4 举例

统计当前目录下所有 Python 文件的总行数：
```bash
find . -name '*.py' | xargs cat | wc -l
```

其中 `find`、`xargs`、`wc` 等命令可以参考 三、常用命令 这一节内容。

## 二、环境变量

### 2.1 概念

Linux 系统中会用很多环境变量来记录配置信息。

环境变量类似于全局变量，可以被各个进程访问到。我们可以通过修改环境变量来方便地修改系统配置。

### 2.2 查看

列出当前环境下的所有环境变量：
```bash
env # 显示当前用户的变量
set # 显示当前 shell 的变量，包括当前用户的变量
export  # 显示当前导出成用户变量的 shell 变量
```

输出某个环境变量的值：
```bash
echo $PATH
```

### 2.3 修改

环境变量的定义、修改、删除操作可以参考《3. shell 语法——变量》这一节的内容。

> 注意：
> 
> 使用 `export` 即可修改环境变量。例如：
> ```bash
> export HOME=/home/acs
> ```
> 即可将 `HOME` 这一环境变量的值修改为 `/home/acs`。

为了将对环境变量的修改应用到未来所有环境下，可以将修改命令放到 `~/.bashrc` 文件中的最后一行。

> 注意：由于 `.bashrc` 的执行顺序为从上到下，且后执行的命令将会把先执行的命令的执行结果覆盖掉，因此将修改命令放到 `.bashrc` 文件中的最后一行，在执行 `.bashrc` 时能够保证修改的命令将会覆盖之前命令的执行结果。

修改完 `~/.bashrc` 文件后，记得执行 `source ~/.bashrc`，来将修改应用到当前的 `bash` 环境下。

> 拓展：
>
> 为何将修改命令放到 `~/.bashrc`，就可以确保修改会影响未来所有的环境呢？
> * 每次启动 `bash`，都会先执行 `~/.bashrc`；
> * 每次 `ssh` 登陆远程服务器，都会启动一个 `bash` 命令行给我们；
> * 每次 `tmux` 新开一个 `pane`，都会启动一个 `bash` 命令行给我们；
> * 所以未来所有新开的环境都会加载我们修改的内容。

### 2.4 常见环境变量

常见环境变量如下所示。

**1. `HOME`**

用户的家目录。

**2. `PATH`**

可执行文件（命令）的存储路径，路径与路径之间用 `:` 分隔。

当某个可执行文件同时出现在多个路径中时，会选择从左到右数第一个路径中的执行。**下列所有存储路径的环境变量，均采用从左到右的优先顺序。**

针对 bash 为例，修改配置文件 `~/.bashrc` 即可永久修改 PATH 值。只需要在 `~/.bashrc` 文件末尾追加以下字符串：
```shell
export PATH=/new/directory/path:$PATH
```
其中 `/new/directory/path` 替换成自己想要添加的可执行文件（命令）的存储路径。

命令的含义是：`PATH` 环境变量在原有值（`$PATH`）的前面添加了新的路径，而 `export` 命令将这个更新后的 `PATH` 环境变量导出到当前 shell 会话及其子进程中；会话结束（终端关闭）后 `PATH` 又恢复成修改前的值。

或在终端依次执行下面两行命令：
```bash
echo 'export PATH=/new/directory/path:$PATH' >> ~/.bashrc

source ~/.bashrc
```
其中，第一行命令会将字符串 `export PATH=/new/directory/path:$PATH` 追加到当前用户的 `~/.bashrc` 文件中，第二行命令立即使 `~/.bashrc` 文件中的更改生效；之后修改后的 `PATH` 会永久生效。

**3. `LD_LIBRARY_PATH`**

用于指定动态链接库（`.so` 文件）的路径，其内容是以冒号分隔的路径列表。

**4. `C_INCLUDE_PATH`**

C 语言的头文件路径，内容是以冒号分隔的路径列表。

**5. `CPLUS_INCLUDE_PATH`**

CPP 的头文件路径，内容是以冒号分隔的路径列表。

**6. `PYTHONPATH`**

Python 导入包的路径，内容是以冒号分隔的路径列表。

**7. `JAVA_HOME`**

jdk 的安装目录。

**8. `CLASSPATH`**

存放 Java 导入类的路径，内容是以冒号分隔的路径列表。

## 三、常用命令

Linux 命令非常多，本节讲解几个常用命令。其他命令依赖于大家根据实际操作环境，边用边查。

### 3.1 系统状况

**1. `top`**

查看所有进程的信息（即 Linux 的任务管理器）。

* 打开后，输入 `M`：按使用内存排序。
* 打开后，输入 `P`：按使用 CPU 排序。
* 打开后，输入 `q`：退出。

**2. `df -h`**

查看硬盘使用情况。

**3. `free -h`**

查看内存使用情况。

**4. `du -sh`**

查看当前目录占用的硬盘空间。

**5. `ps aux`**

查看所有进程。

* `ps aux | grep match-server`：找到并查看 `match-server` 进程的情况。

**6. `kill -9 pid`**

杀死编号为 `pid` 的进程。

* 传递某个具体的信号：`kill -s SIGTERM pid`。

**7. `netstat -nt`**

查看所有网络连接。

**8. `w`**

列出当前登陆的用户。

**9. `ping www.baidu.com`**

检查是否连网。

### 3.2 文件权限

**1. `chmod`**

修改文件权限。

> 注意：
> 
> 命令 `ll` 可以查看所有文件的权限。
>
> 文件权限共有 10 位。
> 
> 其中第 1 位代表文件类型：
> | 文件类型符号 | 文件类型说明 |
> | :--: | :--: |
> | `-` | 普通文件（包括字符和二进制文件），可使用 `touch <file-name>` 创建 |
> | `d` | 目录文件（directory），可使用 `mkdir <dir-name>` 创建 |
> | `c` | 字符串设备文件（char），如路由器等设备 |
> | `b` | 块设备文件（block），如硬盘、光驱等 |
> | `l` | 符号链接文件（link） |
> | `s` | 套接字文件（socket） |
> 
> 后续 9 个字符分为三组，每组 3 个字符，分别表示所有者、所属组和其他用户的权限：
> | 第 2 ~ 4 位 | 第 5 ~ 7 位 | 第 8 ~ 10 位 |
> | :--: | :--: | :--: |
> | 文件所有者权限 | 文件所属组权限 | 其他人权限 |
> | 表示创建文件的人（user）的权限 | 表示与文件所有者处于同一用户组的人（group）的权限 | 表示与文件无关的人（other）的权限 |
>
> 每一组的 3 位都依次对应 `r`、`w`、`x`：
> * `r`（`4`）：可读（read），显示内容。
> * `w`（`2`）：可写（write），编辑内容、删除文件；对于目录来说表示可在目录中新建文件。
> * `x`（`1`）：可执行（execute），执行文件；对于目录来说表示可进入到该目录中。
> 其中，`-` 表示无对应位上的权限。

* `chmod +x xxx`：给 `xxx` 添加可执行权限。
* `chmod -x xxx`：去掉 `xxx` 的可执行权限。
* `chmod 777 xxx`：将 `xxx` 的权限改成 `777`。
* `chmod 777 xxx -R`：递归修改整个文件夹的权限。

### 3.3 文件检索

**1. `find /path/to/directory/ -name '*.py'`**

搜索某个文件路径下的所有 `*.py` 文件。

**2. `grep xxx`**

从 `stdin` 中读入若干行数据，如果某行中包含 `xxx`，则输出该行；否则忽略该行。

`grep` 命令配合 `find` 命令可以实现高效查询。例如：
```bash
find . -name '*.cpp' | xargs cat | grep 'acs_0'
```
即可实现在当前目录下查找包含 `acs_0` 字符串的所有文件行，但是该方式不支持显式被查找的文件行在文件中的行数；而采用 `ag` 命令即可解决这一问题。

**3. `wc`**

统计行数、单词数、字节数。

该命令既可以从 `stdin` 中直接读入内容，也可以在命令行参数中传入文件名列表。

不同参数所对应的统计功能如下所示：
* `wc -l`：统计行数。
* `wc -w`：统计单词数。
* `wc -c`：统计字节数。

**4. `tree`**

展示当前目录的文件结构。

* `tree /path/to/directory/`：展示某个目录的文件结构。
* `tree -a`：展示隐藏文件。

**5. `ag xxx`**

搜索当前目录下的所有文件，检索 `xxx` 字符串。

**6. `cut`**

分割一行内容。

该命令从 `stdin` 中读入多行数据。

示例用法：
* `echo $PATH | cut -d ':' -f 3,5`：输出 `PATH` 用 `:` 分割后第 3、5 列数据。
* `echo $PATH | cut -d ':' -f 3-5`：输出 `PATH` 用 `:` 分割后第 3 - 5 列数据。
* `echo $PATH | cut -c 3,5`：输出 `PATH` 的第 3、5 个字符。
* `echo $PATH | cut -c 3-5`：输出 `PATH` 的第 3 - 5 个字符。
* `cut -d ' ' -f 1 scores.txt`：输出 `scores.txt` 文件的内容以空格为分隔符分隔成 3 列后的第一列的内容。

**7. `sort`**

将每行内容按字典序排序。

* 可以从 `stdin` 中读取多行数据。
* 可以从命令行参数中读取文件名列表。

**8. `xargs`**

将 `stdin` 中的数据用空格或回车分割成命令行参数。

示例用法：
* `find . -name '*.py' | xargs cat | wc -l`：统计当前目录下所有 Python 文件的总行数。

### 3.4 查看文件内容

**1. `more`**

浏览文件内容。

* `回车`：下一行。
* `空格`：下一页。
* `b`：上一页。
* `q`：退出。

**2. `less`**

与 `more` 类似，功能更全。

* `回车`：下一行。
* `y`：上一行。
* `Page Down`：下一页。
* `Page Up`：上一页。
* `q`：退出。

**3. `head -3 xxx`**

展示 `xxx` 的前 3 行内容。

同时支持从 `stdin` 读入内容。

**4. `tail -3 xxx`**

展示 `xxx` 末尾 3 行内容。

同时支持从 `stdin` 读入内容。

### 3.5 用户相关

**1. `history`**

展示当前用户的历史操作。

内容存放在 `~/.bash_history` 中。

### 3.6 工具

**1. `md5sum`**

计算 `md5` 哈希值。

`md5` 哈希值的特征为：只要被加密的文件发生一丁点变化，加密后的 `md5` 哈希值都会发生天翻地覆的变化；且很容易由原文件正着推出加密后的 `md5` 哈希值，但很难（几乎不可能）由加密后的 `md5` 哈希值反推出原文件的内容。

* 可以从 `stdin` 读入内容；
* 也可以在命令行参数中传入文件名列表。

**2. `time command`**

统计 `command` 命令的执行时间。

**3. `ipython3`**

交互式 Python3 环境。

可以当作计算器，或者批量管理文件。

* `! echo "Hello World"`：`!` 表示执行 shell 脚本。

**4. `watch -n 0.1 command`**

每 0.1 秒执行一次 `command` 命令。

关闭 `watch` 命令的组合键为 `Ctrl + c`。

**5. `tar`**

压缩文件。

* `tar -zcvf xxx.tar.gz /path/to/file/*`：压缩。
* `tar -zxvf xxx.tar.gz`：解压缩。

**6. `diff xxx yyy`**

查找文件 `xxx` 与 `yyy` 的不同点。

### 3.7 安装软件

**1. `sudo command`**

以 `root` 身份执行 `command` 命令。

**2. `apt-get install xxx`**

安装软件。

**3. `pip install xxx --user --upgrade`**

安装 Python 包。