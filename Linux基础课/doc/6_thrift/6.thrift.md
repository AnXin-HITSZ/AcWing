# 6. thrift

**目录：**

[TOC]

---

## 一、thrift 简介

在游戏服务中，至少需要维护一个匹配系统和一个数据存储系统。

游戏进程需要向匹配系统提供两个函数 `add_user` 和 `remove_user`，其中 `add_user` 用于匹配系统接收开始匹配的用户，而 `remove_user` 用于从匹配系统中移除取消匹配的用户。匹配系统需要向数据存储系统提供一个函数 `save_data`，用于向数据存储系统提供匹配成功的用户。

上述描述中，将游戏进程、匹配系统和数据存储系统抽象为三个节点，且存在两条有向边：一条为从游戏进程节点指向匹配系统节点，用于提供 `add_user` 和 `remove_user` 函数；另一条为从匹配系统节点指向数据存储节点，用于提供 `save_data` 函数。

> 注意：每条有向边都可以提供多个功能，例如从游戏进程节点指向匹配系统节点的这条有向边提供了 `add_user` 和 `remove_user` 等两个函数的功能。

因此，该游戏服务被抽象为一个有向图，而 thrift 的功能即为提供该有向图中的有向边。

thrift 也被称为 rpc 框架，即**远程函数调用框架**。

thrift 的实现主要包括以下 3 步骤：
1. 定义接口；
2. 实现 server 端；
3. 编写 client 端。

因此，本项目旨在利用 thrift 实现上述游戏服务。其中，游戏进程部署在 AC Terminal 上，采用 Python3 语言编写；匹配系统部署在 AC Terminal 上，采用 C++ 语言编写；数据存储系统部署在 myserver 上，其端口号为 9090，采用已提供好的接口，无需自行编写。

综合以上分析，我们可以得出：在游戏服务节点，需要提供 match-client 端；在匹配系统节点，需要提实现 match-server 端和 save-client 端。

## 二、项目实现过程

> 注意：对于工程项目而言，最好做到 0 warning。

首先在项目的根目录 `thrift/` 下创建 3 个子目录 `match_system`、`game`、`thrift`，分别用来存放匹配系统、游戏服务、thrift 接口的实现代码。

### 2.1 thrift 接口定义

在子目录 `thrift` 下创建接口定义文件 `match.thrift`：
```thrift

```

### 2.2 匹配系统服务端实现（C++）

进入子目录 `match_system` 下，创建代码目录 `src`，进入 `src` 目录并执行 `thrift -r --gen cpp ../../thrift/match.thrift`，以根据接口文件 `match.thrift` 自动初始化匹配系统服务端的代码。

在当前 `src` 目录下，将会生成 `gen-cpp` 目录，存放匹配系统服务端的代码；我们将其重命名为 `match_server`，以区分之后的 `match_client`（即 match-client 端）。

由于需要单开一个线程用于不断进行玩家匹配操作的循环，因此需要使用生产者-消费者模型以完成该功能；生产者和消费者之间的通信可以使用消费队列来实现，而消费队列需要使用锁配合条件变量来实现。

同时，需要定义一个玩家池的类，来存放玩家。

补全 `match_server` 文件夹下的 `Match_server.skeleton.cpp` 文件：
```thrift

```

将其移动到 `match_server` 文件夹的上一层目录 `src` 下，并将其重命名为 `main.cpp`，使用以下方式进行编译与链接：
```bash
# 编译
g++ -c main.cpp

# 链接
g++ *.o -o main -lthrift    # 加入 thrift 的动态链接库
```

> 注意：C++ 语言的 `.cpp` 文件的编译需要先后进行编译和链接两步处理后，才可以变为可执行文件。

由于需要单开一个线程用于不断进行玩家匹配操作，因此

### 2.3 游戏进程客户端实现（Python3）

进入子目录 `game` 下，创建代码目录 `src`，进入 `src` 目录并执行 `thrift -r --gen py ../../thrift/match.thrift`，以根据接口文件 `match.thrift` 自动初始化游戏进程客户端的代码。

在当前 `src` 目录下，将会生成 `gen-py` 目录，存放游戏进程客户端的代码；与匹配系统服务端类似，我们将其重命名为 `match_client`。

新建客户端代码文件 `client.py`，根据 thrift 官方教程中提供的示例代码，补全该客户端业务代码：
```python

```