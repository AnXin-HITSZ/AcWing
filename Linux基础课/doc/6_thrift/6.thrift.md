# 6. thrift

**目录：**

[TOC]

---

> thrift 官网：[thrift 官方网址](https://thrift.apache.org/)。

> thrift 和 Socket 相比，thrift 其优势在于写起来简单，即不需要额外实现跨语言、跨服务器的代码部分。

> 拓展：
> 
> 在 Linux 下如何测试是否联网：
> ```bash
> ping www.baidu.com
> ```
>
> 若可以 `ping` 通，则说明在当前 Linux 下已联网。

## 一、thrift 简介

在游戏服务中，至少需要维护一个匹配系统和一个数据存储系统。

游戏进程需要向匹配系统提供两个函数 `add_user` 和 `remove_user`，其中 `add_user` 用于匹配系统接收开始匹配的用户，而 `remove_user` 用于从匹配系统中移除取消匹配的用户。匹配系统需要向数据存储系统提供一个函数 `save_data`，用于向数据存储系统提供匹配成功的用户。

上述描述中，将游戏进程、匹配系统和数据存储系统抽象为三个节点，且存在两条有向边：一条为从游戏进程节点指向匹配系统节点，用于提供 `add_user` 和 `remove_user` 函数；另一条为从匹配系统节点指向数据存储节点，用于提供 `save_data` 函数。

> 注意：每条有向边都可以提供多个功能，例如从游戏进程节点指向匹配系统节点的这条有向边提供了 `add_user` 和 `remove_user` 等两个函数的功能。

因此，该游戏服务被抽象为一个有向图，而 thrift 的功能即为提供该有向图中的有向边。

thrift 也被称为 rpc 框架，即**远程函数调用框架**。

thrift 的实现主要包括以下 3 步骤：
1. 定义接口；
2. 实现 server 端；
3. 编写 client 端。

因此，本项目旨在利用 thrift 实现上述游戏服务。其中，游戏进程部署在 AC Terminal 上，采用 Python3 语言编写；匹配系统部署在 AC Terminal 上，采用 C++ 语言编写；数据存储系统部署在 myserver 上，其端口号为 9090，采用已提供好的接口，无需自行编写。

综合以上分析，我们可以得出：在游戏服务节点，需要提供 match-client 端；在匹配系统节点，需要提实现 match-server 端和 save-client 端。

> 注意：上述 match-client 端、match-server 端 和 save-client 端被称为**微服务**。

## 二、项目实现过程

> 注意：对于工程项目而言，最好做到 0 warning。

首先在项目的根目录 `thrift/` 下创建 3 个子目录 `match_system`、`game`、`thrift`，分别用来存放匹配系统、游戏服务、thrift 接口的实现代码。

### 2.1 thrift 接口定义

在子目录 `thrift` 下创建接口定义文件 `match.thrift`：
```thrift

```

### 2.2 匹配系统服务端实现（C++）

进入子目录 `match_system` 下，创建代码目录 `src`，进入 `src` 目录并执行 `thrift -r --gen cpp ../../thrift/match.thrift`，以根据接口文件 `match.thrift` 自动初始化匹配系统服务端的代码。

在当前 `src` 目录下，将会生成 `gen-cpp` 目录，存放匹配系统服务端的代码；我们将其重命名为 `match_server`，以区分之后的 `match_client`（即 match-client 端）。

由于需要单开一个线程用于不断进行玩家匹配操作的循环，因此需要使用生产者-消费者模型以完成该功能；生产者和消费者之间的通信可以使用消费队列来实现，而消费队列需要使用锁配合条件变量来实现。

同时，需要定义一个玩家池的类，来存放玩家。

在实现了匹配系统服务端的基础功能之后，我们考虑将匹配机制升级，可按照玩家分值差值进行玩家匹配。

目前我们采用单线程来处理匹配系统服务端的输入输出，因此根据 thrift 官方教程中提供的示例代码，将其升级改为多线程处理服务端。

接下来，我们将优化匹配系统逻辑：即若两个玩家分值差值不匹配而在一定时间范围内没有其他玩家进入匹配，这两名玩家可以“凑合”匹配到一起；需要实现随玩家的匹配秒数增加其匹配分值差值范围也随之增大的效果。

补全 `match_server` 文件夹下的 `Match_server.skeleton.cpp` 文件。由于在数据存储系统客户端还需在此基础上添加逻辑，因此在这里暂不将完备代码展示；该完备代码请移步于《2.4 数据存储系统客户端实现》一节中查看。

将其移动到 `match_server` 文件夹的上一层目录 `src` 下，并将其重命名为 `main.cpp`，使用以下方式进行编译与链接：
```bash
# 编译
g++ -c main.cpp

# 链接
g++ *.o -o main -lthrift    # 加入 thrift 的动态链接库
g++ *.o -o main -lthrift -pthread   # 加入 thrift 和 线程 的动态链接库
```

> 注意：C++ 语言的 `.cpp` 文件的编译需要先后进行编译和链接两步处理后，才可以变为可执行文件。

目前我们采用单线程来处理匹配系统服务端的输入输出，

### 2.3 游戏进程客户端实现（Python3）

进入子目录 `game` 下，创建代码目录 `src`，进入 `src` 目录并执行 `thrift -r --gen py ../../thrift/match.thrift`，以根据接口文件 `match.thrift` 自动初始化游戏进程客户端的代码。

在当前 `src` 目录下，将会生成 `gen-py` 目录，存放游戏进程客户端的代码；与匹配系统服务端类似，我们将其重命名为 `match_client`。

新建客户端代码文件 `client.py`，根据 thrift 官方教程中提供的示例代码，补全该客户端业务代码：
```python

```

> 注意：由于游戏进程客户端部署在 AC Terminal 本地上，因此该服务的 IP 地址为 `localhost`，即为 `127.0.0.1`。

### 2.4 数据存储系统客户端实现

> 拓展：
>
> 如何获取一个字符串的 md5 值？
>
> 使用如下方式可以获取一个字符串的 md5 值：
> ```bash
> md5sum
> ```
>
> 敲出 `md5sum` 后回车并输入待转换的字符串，回车后并按下 `Ctrl + d` 即可获取该字符串的 md5 值，以对该字符串进行加密。

在 `match_system/src` 目录下执行 `thrift -r --gen cpp ../../thrift/save.thrift`，以根据接口文件 `save.thrift` 自动初始化数据存储系统客户端的代码。

同样，在当前 `src` 目录下，将会生成 `gen-cpp` 目录，存放数据存储系统客户端的代码；与之前类似，我们将其重命名为 `save_client`。

进入到重命名为 `save_client` 的目录下，其中 `Save_server.skeleton.cpp` 为服务端的代码文件；由于此次项目只需实现客户端，而服务端直接调用已提供好的接口，因此需要将该文件删掉，以避免 C++ 中出现两个 `main` 函数。

根据 thrift 官方教程中提供的示例代码，补全 `match_system/src/main.cpp` 文件，同时需要注意头文件的引用：
```cpp

```

> 注意：Linux 下的 C++ 代码需要区分自己编写的头文件和系统提供的头文件，自己编写的头文件在 `include` 时使用双引号 `""` 括起来，而系统提供的头文件在 `include` 时使用尖括号 `<>` 括起来。

由于数据存储系统节点是部署在远程服务器 myserver 上，因此在补全数据存储系统客户端的实现时，需要注意将 IP 地址更改为远程服务器 myserver 的 IP 地址。